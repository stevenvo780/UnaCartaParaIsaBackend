# Dockerfile con soporte GPU para TensorFlow.js
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

# Instalar dependencias de compilaci贸n y Node.js 20
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    python3 \
    python3-pip \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Crear directorio de trabajo
WORKDIR /app

# Copiar package.json y package-lock.json
COPY package*.json ./

# Configurar variables para compilaci贸n de TensorFlow
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
ENV CUDA_HOME=/usr/local/cuda

# Instalar dependencias (incluye @tensorflow/tfjs-node-gpu con compilaci贸n)
RUN npm ci --build-from-source

# Copiar el resto del c贸digo
COPY . .

# Exponer puerto
EXPOSE 8080

# Variables de entorno para GPU - usar solo RTX 5070 Ti (GPU 0)
ENV NVIDIA_VISIBLE_DEVICES=0
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV TF_FORCE_GPU_ALLOW_GROWTH=true
ENV TF_CPP_MIN_LOG_LEVEL=2
ENV CUDA_VISIBLE_DEVICES=0

# Comando de inicio
CMD ["npm", "run", "dev"]
